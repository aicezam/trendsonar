{% extends "base.html" %}

{% block title %}{{ settings.APP_NAME }} - 管理{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/codemirror.min.css">
<style>
    .prompts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        padding: 15px 0;
    }
    .prompt-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        transition: box-shadow 0.2s;
    }
    .prompt-card:hover {
        box-shadow: var(--shadow-md);
    }
    .prompt-card h4 {
        margin: 0 0 8px 0;
        font-size: 16px;
        color: var(--text-main);
    }
    .prompt-card p {
        margin: 0 0 15px 0;
        font-size: 13px;
        color: var(--text-secondary);
        flex: 1;
        line-height: 1.4;
    }
    .prompt-actions {
        display: flex;
        justify-content: flex-end;
    }
    
    .admin-subtabs {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
    }
    .admin-subtab {
        padding: 6px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--bg-soft);
        cursor: pointer;
        font-size: 13px;
        color: var(--text-secondary);
    }
    .admin-subtab:hover { background: var(--bg-body); }
    .admin-subtab.active {
        background: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color);
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal {
        background: var(--bg-card);
        width: 800px;
        max-width: 90%;
        max-height: 90vh;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-lg);
    }
    .modal-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .modal-header h3 { margin: 0; font-size: 18px; color: var(--text-main); }
    .modal-close {
        background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);
    }
    .modal-body {
        padding: 20px;
        overflow-y: auto;
    }
    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-main); }
    .form-text { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }
    .form-hint { font-size: 12px; color: var(--text-light); margin-top: 4px; }
</style>
{% endblock %}

{% block content %}
<div class="app-container admin-wrap">
    <div class="admin-card">
        <div class="admin-title">配置管理</div>
        {% if not authed %}
        <div class="admin-row">
            <input id="adminPassword" class="admin-input" type="password" placeholder="输入密码（.env 的 ADMIN_PASSWORD）">
            <button id="adminLoginBtn" class="admin-btn primary">登录</button>
        </div>
        <div id="adminLoginStatus" class="admin-status"></div>
        {% else %}
        <div class="admin-row" style="justify-content: flex-end;">
            <button id="logoutBtn" class="admin-btn danger">退出登录</button>
        </div>
        <div class="admin-tabs">
            <button id="tabConfigBtn" class="admin-tab active" data-tab="config">配置</button>
            <button id="tabSourcesBtn" class="admin-tab" data-tab="sources">新闻源</button>
            <button id="tabPromptsBtn" class="admin-tab" data-tab="prompts">提示词</button>
            <button id="tabLogsBtn" class="admin-tab" data-tab="logs">日志</button>
        </div>
        <div class="admin-panels">
            <div id="panelConfig" class="admin-panel active">
                <div class="admin-log-toolbar">
                    <div class="admin-hint" style="flex:1; margin:0;">编辑并保存 `config.yaml` 后将自动重启以初始化。</div>
                    <button id="reloadConfigBtn" class="admin-btn">重新加载</button>
                    <button id="saveConfigBtn" class="admin-btn primary">保存并重启</button>
                </div>
                <textarea id="configEditor" class="admin-textarea" spellcheck="false" placeholder="加载中..."></textarea>
            </div>
            <div id="panelSources" class="admin-panel">
                <div class="admin-log-toolbar">
                    <div class="admin-hint" style="flex:1; margin:0;">编辑 `news_sources.json`，保存后下次抓取任务生效。</div>
                    <button id="reloadSourcesBtn" class="admin-btn">刷新</button>
                    <button id="saveSourcesBtn" class="admin-btn primary">保存</button>
                </div>
                <textarea id="sourcesEditor" class="admin-textarea" spellcheck="false" placeholder="加载中..."></textarea>
            </div>
            <div id="panelLogs" class="admin-panel">
                <div class="admin-log-toolbar">
                    <button id="refreshLogsBtn" class="admin-btn">刷新</button>
                    <button id="clearLogsBtn" class="admin-btn danger">清空日志</button>
                </div>
                <pre id="logViewer" class="admin-log"></pre>
            </div>
            <div id="panelPrompts" class="admin-panel">
                <div class="admin-log-toolbar">
                    <div class="admin-hint" style="flex:1; margin:0;">管理 AI 功能模块的提示词配置。修改后实时生效。</div>
                    <button id="refreshPromptsBtn" class="admin-btn">刷新</button>
                </div>
                <div id="promptsGroups" class="admin-subtabs"></div>
                <div id="promptsGrid" class="prompts-grid"></div>
            </div>
        </div>
        <div id="adminStatus" class="admin-status"></div>
        {% endif %}
    </div>
    <div id="promptModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">编辑提示词</h3>
                <button class="modal-close" onclick="closePromptModal()">×</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPromptKey">
                <div class="form-group">
                    <label>标题</label>
                    <input type="text" id="editPromptTitle" class="admin-input" readonly style="background: var(--bg-soft);">
                </div>
                <div class="form-group">
                    <label>描述</label>
                    <div id="editPromptDesc" class="form-text"></div>
                </div>
                <div class="form-group">
                    <label>System Prompt (系统提示词)</label>
                    <textarea id="editPromptSystem" class="admin-textarea" rows="8"></textarea>
                </div>
                <div class="form-group">
                    <label>User Prompt (用户提示词模板)</label>
                    <textarea id="editPromptUser" class="admin-textarea" rows="8"></textarea>
                    <div class="form-hint">支持 {variable} 形式的占位符，请勿修改占位符名称。</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="admin-btn" onclick="closePromptModal()">取消</button>
                <button class="admin-btn primary" onclick="savePrompt()">保存修改</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/codemirror.min.js"></script>
<script src="/static/yaml.min.js"></script>
<script>
    const authed = {{ "true" if authed else "false" }};
    let codeMirrorEditor = null;
    let sourcesEditorCM = null;
    let logsTimer = null;
    let activeTab = "config";
    
    // Lazy loading variables
    let fullLogLines = [];
    let renderedLimit = 200;
    const LOG_PAGE_SIZE = 200;

    function initCodeEditor() {
        const editor = document.getElementById("configEditor");
        if (editor && window.CodeMirror && !codeMirrorEditor) {
            codeMirrorEditor = window.CodeMirror.fromTextArea(editor, {
                mode: "yaml",
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 2,
                tabSize: 2,
            });
        }
        
        const srcEditor = document.getElementById("sourcesEditor");
        if (srcEditor && window.CodeMirror && !sourcesEditorCM) {
            sourcesEditorCM = window.CodeMirror.fromTextArea(srcEditor, {
                mode: { name: "javascript", json: true },
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 2,
                tabSize: 2,
            });
        }
        
        resizeEditors();
    }

    function getEditorValue() {
        const editor = document.getElementById("configEditor");
        if (codeMirrorEditor) return codeMirrorEditor.getValue();
        return editor?.value || "";
    }

    function getSourcesValue() {
        const editor = document.getElementById("sourcesEditor");
        if (sourcesEditorCM) return sourcesEditorCM.getValue();
        return editor?.value || "";
    }

    function setEditorValue(v) {
        const editor = document.getElementById("configEditor");
        if (codeMirrorEditor) {
            codeMirrorEditor.setValue(v || "");
            codeMirrorEditor.refresh();
        } else if (editor) {
            editor.value = v || "";
        }
        resizeEditors();
    }
    
    function setSourcesValue(v) {
        const editor = document.getElementById("sourcesEditor");
        if (sourcesEditorCM) {
            sourcesEditorCM.setValue(v || "");
            sourcesEditorCM.refresh();
        } else if (editor) {
            editor.value = v || "";
        }
        resizeEditors();
    }

    function setAppNameFromYaml(yamlText) {
        const m = (yamlText || "").match(/^\s*APP_NAME\s*:\s*(.+?)\s*$/m);
        if (!m) return;
        const newName = (m[1] || "").replace(/^['"]|['"]$/g, "").trim();
        if (!newName) return;

        document.title = newName + " - 管理";
        const logoText = document.querySelector(".logo span:last-child");
        if (logoText) logoText.textContent = newName;
    }

    function resizeEditors() {
        const configPanel = document.getElementById("panelConfig");
        const configTextarea = document.getElementById("configEditor");

        if (configPanel && configTextarea && configPanel.classList.contains("active")) {
            const rect = configTextarea.getBoundingClientRect();
            // Try to find the wrapper if CodeMirror is initialized
            const wrapper = configPanel.querySelector(".CodeMirror");
            const top = wrapper ? wrapper.getBoundingClientRect().top : rect.top;
            
            const available = Math.max(260, window.innerHeight - top - 20);
            if (codeMirrorEditor) {
                codeMirrorEditor.setSize("100%", available + "px");
                codeMirrorEditor.refresh();
            } else {
                configTextarea.style.minHeight = available + "px";
            }
        }
        
        const sourcesPanel = document.getElementById("panelSources");
        const sourcesTextarea = document.getElementById("sourcesEditor");
        
        if (sourcesPanel && sourcesTextarea && sourcesPanel.classList.contains("active")) {
             // For sources panel, we have a toolbar above it, so we need to calculate available space carefully
             const wrapper = sourcesPanel.querySelector(".CodeMirror");
             // If wrapper exists, use its top. If not, use textarea's top.
             // But wait, if CodeMirror is active, textarea is hidden.
             const top = wrapper ? wrapper.getBoundingClientRect().top : sourcesTextarea.getBoundingClientRect().top;
             
             const available = Math.max(260, window.innerHeight - top - 20);
             if (sourcesEditorCM) {
                 sourcesEditorCM.setSize("100%", available + "px");
                 sourcesEditorCM.refresh();
             } else {
                 sourcesTextarea.style.minHeight = available + "px";
             }
        }
    }

    function setStatus(el, msg, cls) {
        if (!el) return;
        el.textContent = msg || "";
        el.className = "admin-status" + (cls ? (" " + cls) : "");
    }

    async function doLogin() {
        const pwdEl = document.getElementById("adminPassword");
        const statusEl = document.getElementById("adminLoginStatus");
        const password = (pwdEl?.value || "").trim();
        if (!password) {
            setStatus(statusEl, "请输入密码", "error");
            return;
        }
        setStatus(statusEl, "登录中...", "");
        const resp = await fetch("/admin/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password })
        });
        if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            setStatus(statusEl, data.message || "登录失败", "error");
            return;
        }
        location.reload();
    }

    async function loadConfig() {
        const statusEl = document.getElementById("adminStatus");
        setStatus(statusEl, "加载配置中...", "");
        const resp = await fetch("/api/admin/config", { method: "GET" });
        if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            setStatus(statusEl, data.detail || "加载失败", "error");
            return;
        }
        const data = await resp.json();
        setEditorValue(data.yaml || "");
        setAppNameFromYaml(data.yaml || "");
        setStatus(statusEl, "已加载。保存后将自动重启。", "ok");
    }
    
    async function loadSources() {
        const statusEl = document.getElementById("adminStatus");
        setStatus(statusEl, "加载新闻源中...", "");
        const resp = await fetch("/api/admin/news_sources", { method: "GET" });
        if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            setStatus(statusEl, data.detail || "加载失败", "error");
            return;
        }
        const data = await resp.json();
        setSourcesValue(data.json || "[]");
        setStatus(statusEl, "新闻源已加载 (路径: " + (data.path || "") + ")", "ok");
    }

    async function waitForRestartAndReload() {
        for (let i = 0; i < 30; i++) {
            await new Promise((r) => setTimeout(r, 1000));
            try {
                const resp = await fetch("/api/admin/config", { method: "GET", cache: "no-store" });
                if (resp.ok) {
                    location.reload();
                    return;
                }
            } catch (e) {}
        }
    }

    async function saveConfig() {
        const statusEl = document.getElementById("adminStatus");
        setStatus(statusEl, "保存中...", "");
        const yamlText = getEditorValue();
        const resp = await fetch("/api/admin/config", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ yaml_text: yamlText })
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) {
            setStatus(statusEl, data.detail || "保存失败", "error");
            return;
        }
        setStatus(statusEl, "保存成功，服务即将重启（请等待 2-5 秒后刷新）。", "ok");
        setAppNameFromYaml(yamlText);
        waitForRestartAndReload();
    }

    async function saveSources() {
        const statusEl = document.getElementById("adminStatus");
        setStatus(statusEl, "保存新闻源中...", "");
        const jsonText = getSourcesValue();
        
        // Basic validation
        try {
            JSON.parse(jsonText);
        } catch (e) {
            setStatus(statusEl, "JSON 格式错误: " + e.message, "error");
            return;
        }

        const resp = await fetch("/api/admin/news_sources", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ json_text: jsonText })
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) {
            setStatus(statusEl, data.detail || "保存失败", "error");
            return;
        }
        setStatus(statusEl, "保存成功，下次任务时生效。", "ok");
    }

    async function fetchLogs() {
        const logEl = document.getElementById("logViewer");
        if (!logEl) return;
        const resp = await fetch("/api/admin/logs", { method: "GET", cache: "no-store" });
        if (!resp.ok) {
            logEl.textContent = "日志加载失败（可能未登录或服务异常）";
            return;
        }
        const data = await resp.json().catch(() => ({}));
        const raw = data.logs || "";
        
        const newLines = raw ? raw.split(/\r?\n/).reverse() : [];
        
        // If content is identical (same length and same newest line), skip render to avoid flicker
        if (fullLogLines.length > 0 && newLines.length === fullLogLines.length && newLines[0] === fullLogLines[0]) {
            return;
        }
        
        fullLogLines = newLines;
        renderLogs();
    }

    function renderLogs() {
        const logEl = document.getElementById("logViewer");
        if (!logEl) return;

        // Check if user is at the top (viewing newest logs)
        const isAtTop = logEl.scrollTop < 50;
        
        const slice = fullLogLines.slice(0, renderedLimit);
        logEl.textContent = slice.join("\n");
        
        // If user was at top, keep them at top so they see new logs
        if (isAtTop) {
            logEl.scrollTop = 0;
        }
    }

    function onLogScroll() {
        const logEl = document.getElementById("logViewer");
        if (!logEl) return;
        
        const { scrollTop, scrollHeight, clientHeight } = logEl;
        // If scrolled near bottom, load more
        if (scrollTop + clientHeight >= scrollHeight - 50) {
            if (renderedLimit < fullLogLines.length) {
                renderedLimit += LOG_PAGE_SIZE;
                // Preserve scroll position (though usually not needed as we append to bottom)
                // renderLogs will update content, browser usually keeps scrollTop relative to top.
                // Since we append to bottom, the view shouldn't jump.
                renderLogs();
            }
        }
    }

    async function clearLogs() {
        const resp = await fetch("/api/admin/logs", { method: "DELETE" });
        if (!resp.ok) return;
        fullLogLines = [];
        renderedLimit = LOG_PAGE_SIZE;
        await fetchLogs();
    }

    function setTab(tab) {
        const statusEl = document.getElementById("adminStatus");
        if (statusEl) setStatus(statusEl, "", "");

        activeTab = tab;
        const tabConfigBtn = document.getElementById("tabConfigBtn");
        const tabSourcesBtn = document.getElementById("tabSourcesBtn");
        const tabLogsBtn = document.getElementById("tabLogsBtn");
        const tabPromptsBtn = document.getElementById("tabPromptsBtn");
        
        const panelConfig = document.getElementById("panelConfig");
        const panelSources = document.getElementById("panelSources");
        const panelLogs = document.getElementById("panelLogs");
        const panelPrompts = document.getElementById("panelPrompts");

        if (tabConfigBtn) tabConfigBtn.classList.toggle("active", tab === "config");
        if (tabSourcesBtn) tabSourcesBtn.classList.toggle("active", tab === "sources");
        if (tabLogsBtn) tabLogsBtn.classList.toggle("active", tab === "logs");
        if (tabPromptsBtn) tabPromptsBtn.classList.toggle("active", tab === "prompts");
        
        if (panelConfig) panelConfig.classList.toggle("active", tab === "config");
        if (panelSources) panelSources.classList.toggle("active", tab === "sources");
        if (panelLogs) panelLogs.classList.toggle("active", tab === "logs");
        if (panelPrompts) panelPrompts.classList.toggle("active", tab === "prompts");

        if (logsTimer) {
            clearInterval(logsTimer);
            logsTimer = null;
        }
        
        if (tab === "logs") {
            // Reset state when entering logs tab
            renderedLimit = LOG_PAGE_SIZE;
            fullLogLines = []; 
            fetchLogs();
            logsTimer = setInterval(fetchLogs, 1500);
        } else if (tab === "prompts") {
            loadPrompts();
        } else if (tab === "sources") {
             loadSources();
             // Delay resize to allow DOM to settle
             setTimeout(resizeEditors, 10);
        } else {
            // config
            // We assume config is already loaded, but we can reload if needed. 
            // Usually we just resize.
            setTimeout(resizeEditors, 10);
        }
    }

    async function logout() {
        await fetch("/admin/logout", { method: "POST" });
        location.reload();
    }

    // --- Prompts Management ---
    let allPrompts = {};
    let activePromptGroup = "全部";

    async function loadPrompts() {
        const statusEl = document.getElementById("adminStatus");
        setStatus(statusEl, "加载提示词中...", "");
        
        const resp = await fetch("/api/system/prompts", { method: "GET" });
        if (!resp.ok) {
            setStatus(statusEl, "加载提示词失败", "error");
            return;
        }
        
        const data = await resp.json();
        allPrompts = data;
        renderPromptGroups();
        renderPrompts();
        setStatus(statusEl, "提示词加载完成", "ok");
    }

    function renderPromptGroups() {
        const groups = new Set(["全部"]);
        Object.values(allPrompts).forEach(p => {
            if (p.group) groups.add(p.group);
            else groups.add("未分类");
        });

        const container = document.getElementById("promptsGroups");
        if (!container) return;
        container.innerHTML = "";

        const sortedGroups = Array.from(groups).sort((a, b) => {
             if (a === "全部") return -1;
             if (b === "全部") return 1;
             return a.localeCompare(b);
        });

        sortedGroups.forEach(g => {
            const btn = document.createElement("div");
            btn.className = "admin-subtab" + (g === activePromptGroup ? " active" : "");
            btn.textContent = g;
            btn.onclick = () => {
                activePromptGroup = g;
                renderPromptGroups(); // Re-render to update active class
                renderPrompts();
            };
            container.appendChild(btn);
        });
    }

    function renderPrompts() {
        const grid = document.getElementById("promptsGrid");
        if (!grid) return;
        grid.innerHTML = "";

        // Sort by key
        const keys = Object.keys(allPrompts).sort();
        
        keys.forEach(key => {
            const item = allPrompts[key];
            const itemGroup = item.group || "未分类";
            
            if (activePromptGroup !== "全部" && itemGroup !== activePromptGroup) {
                return;
            }

            const card = document.createElement("div");
            card.className = "prompt-card";
            card.innerHTML = `
                <h4>${item.title || key} <span style="font-weight:normal; font-size:12px; color:var(--text-light);">(${key})</span></h4>
                <div style="font-size:12px; color:var(--primary-color); margin-bottom:5px;">${item.group || "未分类"}</div>
                <p>${item.description || "暂无描述"}</p>
                <div class="prompt-actions">
                    <button class="admin-btn small" onclick="editPrompt('${key}')">编辑</button>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    window.editPrompt = function(key) {
        const item = allPrompts[key];
        if (!item) return;

        document.getElementById("editPromptKey").value = key;
        document.getElementById("editPromptTitle").value = item.title || "";
        document.getElementById("editPromptDesc").textContent = item.description || "";
        document.getElementById("editPromptSystem").value = item.system_prompt || "";
        document.getElementById("editPromptUser").value = item.user_prompt || "";
        
        document.getElementById("modalTitle").textContent = "编辑提示词 - " + (item.title || key);
        document.getElementById("promptModal").style.display = "flex";
    };

    window.closePromptModal = function() {
        document.getElementById("promptModal").style.display = "none";
    };

    window.savePrompt = async function() {
        const key = document.getElementById("editPromptKey").value;
        const systemPrompt = document.getElementById("editPromptSystem").value;
        const userPrompt = document.getElementById("editPromptUser").value;
        
        if (!key) return;

        const statusEl = document.getElementById("adminStatus");
        setStatus(statusEl, "保存提示词中...", "");

        const payload = {
            system_prompt: systemPrompt,
            user_prompt: userPrompt
        };

        const resp = await fetch(`/api/system/prompts/${key}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            setStatus(statusEl, err.detail || "保存失败", "error");
            alert("保存失败: " + (err.detail || "未知错误"));
            return;
        }

        const resData = await resp.json();
        // Update local cache
        if (resData.data) {
            allPrompts[key] = resData.data;
        }
        
        closePromptModal();
        setStatus(statusEl, "提示词保存成功", "ok");
    };

    document.addEventListener("DOMContentLoaded", () => {
        if (!authed) {
            document.getElementById("adminLoginBtn")?.addEventListener("click", doLogin);
            document.getElementById("adminPassword")?.addEventListener("keydown", (e) => {
                if (e.key === "Enter") doLogin();
            });
            return;
        }
        document.getElementById("reloadConfigBtn")?.addEventListener("click", loadConfig);
        document.getElementById("saveConfigBtn")?.addEventListener("click", saveConfig);
        document.getElementById("logoutBtn")?.addEventListener("click", logout);
        
        document.getElementById("tabConfigBtn")?.addEventListener("click", () => setTab("config"));
        document.getElementById("tabSourcesBtn")?.addEventListener("click", () => setTab("sources"));
        document.getElementById("tabLogsBtn")?.addEventListener("click", () => setTab("logs"));
        document.getElementById("tabPromptsBtn")?.addEventListener("click", () => setTab("prompts"));
        
        document.getElementById("refreshPromptsBtn")?.addEventListener("click", loadPrompts);
        
        document.getElementById("refreshLogsBtn")?.addEventListener("click", fetchLogs);
        document.getElementById("clearLogsBtn")?.addEventListener("click", clearLogs);
        
        document.getElementById("reloadSourcesBtn")?.addEventListener("click", loadSources);
        document.getElementById("saveSourcesBtn")?.addEventListener("click", saveSources);
        
        const logViewer = document.getElementById("logViewer");
        if (logViewer) logViewer.addEventListener("scroll", onLogScroll);

        window.addEventListener("resize", resizeEditors);
        initCodeEditor();
        loadConfig();
    });
</script>
{% endblock %}
