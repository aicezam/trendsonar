{% extends "base.html" %}
{% block title %}专题 - {{ settings.APP_NAME }}{% endblock %}
{% block head %}
{% endblock %}

{% block content %}
<div class="app-container page-wrap">
    <div class="page-title">专题追踪</div>
    <div class="hint">自动生成/更新专题并沉淀时间轴。</div>
    <div id="loading" class="loading">加载中...</div>
    <div id="empty" class="empty" style="display:none;">暂无专题。请等待全流程任务运行后自动生成。</div>
    <div id="list" class="topic-list"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const IS_ADMIN = {{ "true" if authed else "false" }};

    function fmtTime(iso) {
        if (!iso) return "-";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        return d.toLocaleString();
    }

    function el(tag, attrs = {}, children = []) {
        const node = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
            if (k === "class") node.className = v;
            else if (k === "text") node.textContent = v;
            else if (k.startsWith("on")) node.addEventListener(k.substring(2).toLowerCase(), v);
            else node.setAttribute(k, v);
        }
        for (const c of children) node.appendChild(c);
        return node;
    }

    async function deleteTopic(e, id, name) {
        e.stopPropagation();
        if (!confirm(`确定要删除专题 "${name}" 吗？此操作不可恢复。`)) return;
        
        try {
            const resp = await fetch(`/api/topics/${id}`, { method: "DELETE" });
            if (!resp.ok) throw new Error("删除失败");
            loadTopics();
        } catch (err) {
            alert(err.message);
        }
    }

    async function loadTopics() {
        const loading = document.getElementById("loading");
        const empty = document.getElementById("empty");
        const list = document.getElementById("list");
        loading.style.display = "block";
        empty.style.display = "none";
        list.innerHTML = "";

        try {
            const resp = await fetch("/api/topics/list?size=100", { method: "GET", cache: "no-store" });
            if (!resp.ok) throw new Error("请求失败");
            const data = await resp.json();
            const items = (data && data.items) || [];
            if (!items.length) {
                empty.style.display = "block";
                return;
            }

            for (const t of items) {
                const card = el("div", { class: "topic-card" });
                card.addEventListener("click", () => {
                    window.location.href = `/topics/${t.id}`;
                });

                const header = el("div", { style: "display: flex; justify-content: space-between; align-items: flex-start;" });
                
                const nameDiv = el("div", { class: "topic-name", text: t.name || "未命名专题", style: "flex: 1;" });
                header.appendChild(nameDiv);

                if (IS_ADMIN) {
                    const delBtn = el("button", { 
                        text: "删除",
                        style: "background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 10px; white-space: nowrap;",
                        onClick: (e) => deleteTopic(e, t.id, t.name)
                    });
                    header.appendChild(delBtn);
                }
                card.appendChild(header);

                const meta = el("div", { class: "meta" });
                meta.appendChild(el("span", { class: "tag", text: `发布时间 ${fmtTime(t.start_time)}` }));
                meta.appendChild(el("span", { class: "tag", text: `更新时间 ${fmtTime(t.updated_time)}` }));
                card.appendChild(meta);

                card.appendChild(el("div", { class: "topic-summary", text: t.summary || "暂无描述" }));

                list.appendChild(card);
            }
        } catch (e) {
            empty.style.display = "block";
            empty.textContent = "加载失败，请稍后重试。";
        } finally {
            loading.style.display = "none";
        }
    }

    loadTopics();
</script>
{% endblock %}
