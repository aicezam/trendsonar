{% extends "base.html" %}
{% block title %}{{ settings.APP_NAME }} - èˆ†æƒ…åˆ†ææŠ¥è¡¨{% endblock %}
{% block head %}
    <script src="/static/echarts.min.js"></script>
    <script src="/static/marked.min.js"></script>
{% endblock %}
{% block content %}

<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div>TrendSonar æ­£åœ¨å…¨ç½‘åˆ†æä¸­...</div>
</div>

<div class="container">
    <!-- Filter Section -->
    <div class="filter-section">
        <div class="search-bar-wrapper">
            <div class="input-group">
                <span class="input-icon">ğŸ”</span>
                <input type="text" id="keyword" class="input-text-search" placeholder="è¾“å…¥å…³é”®è¯ (ä¾‹å¦‚: 'äººå·¥æ™ºèƒ½', 'æ–°èƒ½æº')">
            </div>
            <button class="btn-search" onclick="openSettingsModal()">ç”Ÿæˆæ·±åº¦æŠ¥å‘Š</button>
        </div>
        
        <!-- Recent Reports -->
        <div class="recent-reports" id="recentReportsList">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Info Header -->
    <div class="report-header" id="reportInfoCard" style="display:none;">
        <div class="report-title-group">
            <h1 id="infoTitle">èˆ†æƒ…åˆ†ææŠ¥å‘Š</h1>
            <div class="report-meta">
                <span id="infoTime">æ—¶é—´èŒƒå›´ï¼š-</span> &nbsp;|&nbsp; 
                <span id="infoDesc">åˆ†æç»´åº¦ï¼š-</span>
            </div>
            <div id="historyQuickAccess" class="history-quick-access"></div>
        </div>
        <div class="report-actions">
            <button onclick="loadDefaultReport()" id="btnBackToGlobal" style="display:none;">â¬… è¿”å›å¤§ç›˜</button>
        </div>
    </div>

    <!-- Metrics Grid -->
    <div class="metrics-grid" id="metricsSection" style="display:none;">
        <div class="metric-card">
            <div class="metric-label">å…¨ç½‘çƒ­ç‚¹æ•°</div>
            <div class="metric-value" id="valTotal">0</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">å¹³å‡çƒ­åº¦æŒ‡æ•°</div>
            <div class="metric-value" id="valAvgHeat">0</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">æœ€é«˜çƒ­åº¦å³°å€¼</div>
            <div class="metric-value" id="valMaxHeat">0</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">ç»¼åˆæƒ…æ„ŸæŒ‡æ•°</div>
            <div class="metric-value" id="valSentiment">0</div>
            <div class="metric-sub">0-100 (50=ä¸­ç«‹)</div>
        </div>
        <div class="metric-card" style="display:none;">
            <div class="metric-label">é«˜å±é¢„è­¦æ•°</div>
            <div class="metric-value" id="valRisk" style="color: #ef4444;">0</div>
        </div>
        <div class="metric-card" style="display:none;">
            <div class="metric-label">åˆ†ææ—¶é—´è·¨åº¦</div>
            <div class="metric-value" id="valTimeRange" style="font-size:1.25rem; line-height: 2.1rem;">-</div>
        </div>
    </div>

    <!-- AI Analysis -->
    <div class="analysis-card" id="aiSection" style="display:none;">
        <div class="chart-header ai-header">
            <span class="chart-title" style="font-size: 1.25rem;">ğŸ¤– AI èˆ†æƒ…æ™ºèƒ½ç»¼è¿°</span>
        </div>
        <div class="analysis-content" id="aiContent"></div>
    </div>

    <!-- Common Charts -->
    <div id="commonCharts">
        <div class="chart-row full-width">
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title">ğŸ“ˆ çƒ­åº¦ä¸æ–‡ç« è¶‹åŠ¿</span>
                </div>
                <div id="chartTrend" class="chart-container"></div>
            </div>
        </div>

        <div class="chart-row full-width">
            <div class="chart-card auto-height">
                <div class="chart-header">
                    <span class="chart-title">â˜ï¸ å…¨ç½‘èˆ†æƒ…çƒ­è¯äº‘</span>
                    <select class="chart-filter" id="filter-word_cloud" onchange="updateChart('word_cloud', this.value)"></select>
                </div>
                <div id="wordCloud" class="word-cloud-container"></div>
            </div>
        </div>

        <div class="chart-row two-cols">
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title">ğŸ“¢ åª’ä½“æ¥æºåˆ†å¸ƒ</span>
                    <select class="chart-filter" id="filter-source" onchange="updateChart('source', this.value)"></select>
                </div>
                <div id="chartSource" class="chart-container"></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title">ğŸ­ æƒ…æ„Ÿå€¾å‘å æ¯”</span>
                    <select class="chart-filter" id="filter-sentiment" onchange="updateChart('sentiment', this.value)"></select>
                </div>
                <div id="chartSentiment" class="chart-container"></div>
                <div style="text-align: center; font-size: 0.85rem; color: #64748b; margin-top: 10px; padding: 8px; background: #f8fafc; border-radius: 8px;">
                    ä¸»è¦è´Ÿé¢è¯: <span id="negKeywords" style="color: #ef4444; font-weight: 500;"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyword Specific Charts -->
    <div id="keywordView" style="display:none;">
        <div class="chart-row full-width">
            <div class="chart-card large-chart">
                <div class="chart-header">
                    <span class="chart-title">ğŸ”— å…³é”®è¯å…±ç°å…³ç³»å›¾è°±</span>
                </div>
                <div id="chartCorrelation" class="chart-container"></div>
            </div>
        </div>

        <div class="chart-row full-width">
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title">ğŸ“Š å…³é”®è¯é¢‘æ¬¡æ¼”å˜è¶‹åŠ¿</span>
                </div>
                <div id="chartFreqTrend" class="chart-container"></div>
            </div>
        </div>

        <div class="chart-row full-width">
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title">ğŸŒ¡ï¸ ç›¸å…³æ–°é—»æƒ…æ„Ÿèµ°åŠ¿</span>
                </div>
                <div id="chartSentimentTrend" class="chart-container"></div>
            </div>
        </div>
    </div>

    <!-- Detail Table -->
    <div class="table-card" id="tableSection" style="display:none;">
        <div class="table-header-wrapper">
            <span class="chart-title" style="font-size: 1.1rem;">ğŸ”¥ çƒ­é—¨èˆ†æƒ…åˆ—è¡¨ (Top 50)</span>
            <select class="chart-filter" id="filter-list" onchange="updateChart('list', this.value)"></select>
        </div>
        <div id="hotNewsList" class="news-list"></div>
        <div id="newsPagination" class="pagination"></div>
    </div>
</div>

<!-- History Sidebar -->
<div class="history-sidebar" id="historySidebar">
    <div class="history-header">
        <span id="historyTitle">å†å²æŠ¥å‘Š</span>
        <span class="close-history" onclick="toggleHistorySidebar()" style="cursor:pointer; font-size:1.5rem;">Ã—</span>
    </div>
    <div class="history-list" id="historyList"></div>
</div>

<!-- Floating Button Removed -->

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">ç”Ÿæˆé…ç½®</div>
            <div class="modal-close" onclick="closeSettingsModal()">&times;</div>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">æ—¶é—´èŒƒå›´</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="date" id="startDate" class="form-control">
                    <span style="color:var(--text-secondary)">è‡³</span>
                    <input type="date" id="endDate" class="form-control">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">é¢†åŸŸ/åˆ†ç±»</label>
                <div class="custom-select" id="domainSelect">
                    <div class="select-trigger" onclick="toggleSelect(this)">
                        <span id="domainTriggerText">é€‰æ‹©é¢†åŸŸ (å…¨éƒ¨)</span>
                        <span style="font-size: 0.7rem;">â–¼</span>
                    </div>
                    <div class="select-options">
                        <label><input type="checkbox" id="cat-all" value="all" checked onchange="toggleAllDomains(this)"> <strong>å…¨éƒ¨</strong></label>
                        <div id="domainOptionsList"></div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">åœ°åŒº (å¯é€‰)</label>
                <div class="custom-select" id="regionSelect">
                    <div class="select-trigger" onclick="toggleSelect(this)">
                        <span id="regionTriggerText">é€‰æ‹©åœ°åŒº (å…¨éƒ¨)</span>
                        <span style="font-size: 0.7rem;">â–¼</span>
                    </div>
                    <div class="select-options">
                        <label><input type="checkbox" id="reg-all" value="all" checked onchange="toggleAllRegions(this)"> <strong>å…¨éƒ¨</strong></label>
                        <div id="regionOptionsList"></div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">åª’ä½“æ¥æº (å¯é€‰)</label>
                <div class="custom-select" id="sourceSelect">
                    <div class="select-trigger" onclick="toggleSelect(this)">
                        <span id="sourceTriggerText">é€‰æ‹©æ¥æº (å…¨éƒ¨)</span>
                        <span style="font-size: 0.7rem;">â–¼</span>
                    </div>
                    <div class="select-options">
                        <label><input type="checkbox" id="src-all" value="all" checked onchange="toggleAllSources(this)"> <strong>å…¨éƒ¨</strong></label>
                        <div id="sourceOptionsList"></div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">åˆ†ææ•°æ®é‡ (Top N)</label>
                <select id="limitSelect" class="form-control">
                    <option value="50">Top 50 (å¿«é€Ÿ)</option>
                    <option value="100">Top 100</option>
                    <option value="500">Top 500</option>
                    <option value="2000">Top 2000</option>
                    <option value="0" selected>ä¸é™ (åˆ†æå…¨é‡æ•°æ®)</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeSettingsModal()">å–æ¶ˆ</button>
            <button class="btn-confirm" onclick="confirmGenerate()">å¼€å§‹ç”Ÿæˆ</button>
        </div>
    </div>
</div>

<!-- Background Task Notification -->
<div id="bgNotification" style="display:none; position:fixed; top:80px; right:20px; background:#fff; padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:9999; border-left: 4px solid #3b82f6; max-width: 320px; animation: slideIn 0.3s ease-out;">
    <div style="font-weight:bold; margin-bottom:5px; color:#1e293b;">ğŸš€ æŠ¥è¡¨æ­£åœ¨åå°ç”Ÿæˆ</div>
    <div style="font-size:0.85rem; color:#64748b; margin-bottom:10px; line-height: 1.4;">
        ç³»ç»Ÿæ­£åœ¨è¿›è¡Œæ·±åº¦åˆ†æï¼Œè¿™å¯èƒ½éœ€è¦ 1-2 åˆ†é’Ÿã€‚<br>
        æ‚¨å¯ä»¥ç»§ç»­æµè§ˆæˆ–ç¦»å¼€é¡µé¢ï¼Œç”Ÿæˆå®Œæˆåå°†è‡ªåŠ¨åŠ è½½ï¼Œæˆ–åœ¨å†å²è®°å½•ä¸­æŸ¥çœ‹ã€‚
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <span id="pollingStatus" style="font-size:0.75rem; color:#3b82f6;">â³ æ­£åœ¨å¤„ç†...</span>
        <button onclick="hideBackgroundNotification()" style="border:1px solid #e2e8f0; background:#fff; color:#64748b; cursor:pointer; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem;">éšè—</button>
    </div>
</div>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
</style>

{% endblock %}
{% block scripts %}
<script>
    const NEWS_CATEGORIES = {{ settings.NEWS_CATEGORIES | tojson }};

    // åˆå§‹åŒ–é»˜è®¤æ—¶é—´èŒƒå›´ä¸º7å¤©
    const today = new Date();
    const lastWeek = new Date(today);
    lastWeek.setDate(today.getDate() - 7);
    
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];

    // Chart Instances
    let chartTrend = null, chartSource = null, chartSentiment = null;
    let chartCorrelation = null, chartFreqTrend = null, chartSentimentTrend = null;

    // Init Filters
    populateFilters();
    populateSourceOptions();
    populateRegionOptions();
    loadRecentReports();
    loadHistoryList('');

    // Close select when clicking outside
    document.addEventListener('click', function(e) {
        document.querySelectorAll('.custom-select').forEach(select => {
            if (!select.contains(e.target)) {
                select.querySelector('.select-options').classList.remove('show');
            }
        });
    });

    function toggleSelect(el) {
        document.querySelectorAll('.select-options.show').forEach(opt => {
            if (opt !== el.nextElementSibling) {
                opt.classList.remove('show');
            }
        });
        el.nextElementSibling.classList.toggle('show');
    }

    function populateFilters() {
        const list = document.getElementById('domainOptionsList');
        NEWS_CATEGORIES.forEach(cat => {
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" class="cat-cb" value="${cat}" checked onchange="checkAllState()"> <span>${cat}</span>`;
            list.appendChild(label);
        });

        const chartFilters = ['filter-word_cloud', 'filter-source', 'filter-sentiment', 'filter-list'];
        chartFilters.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            select.innerHTML = '<option value="all">å…¨ç½‘ (æ‰€æœ‰é¢†åŸŸ)</option>';
            NEWS_CATEGORIES.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                select.appendChild(opt);
            });
        });
    }

    async function populateSourceOptions() {
        try {
            const res = await fetch('/api/sources');
            const sources = await res.json();
            const list = document.getElementById('sourceOptionsList');
            
            if (list && sources.length > 0) {
                list.innerHTML = '';
                sources.forEach(src => {
                    const label = document.createElement('label');
                    label.innerHTML = `<input type="checkbox" class="src-cb" value="${src}" checked onchange="checkAllSourceState()"> <span>${src}</span>`;
                    list.appendChild(label);
                });
            } else if (list) {
                list.innerHTML = '<div style="padding:10px;color:#999;font-size:0.9rem">æš‚æ— æ¥æºæ•°æ®</div>';
            }
        } catch (e) {
            console.error("åŠ è½½åª’ä½“æºå¤±è´¥", e);
        }
    }

    async function populateRegionOptions() {
        try {
            const res = await fetch('/api/regions');
            const regions = await res.json();
            const list = document.getElementById('regionOptionsList');
            
            if (list && regions.length > 0) {
                list.innerHTML = '';
                regions.forEach(reg => {
                    const label = document.createElement('label');
                    label.innerHTML = `<input type="checkbox" class="reg-cb" value="${reg}" checked onchange="checkAllRegionState()"> <span>${reg}</span>`;
                    list.appendChild(label);
                });
            } else if (list) {
                list.innerHTML = '<div style="padding:10px;color:#999;font-size:0.9rem">æš‚æ— åœ°åŒºæ•°æ®</div>';
            }
        } catch (e) {
            console.error("åŠ è½½åœ°åŒºå¤±è´¥", e);
        }
    }

    function toggleAllRegions(el) {
        const cbs = document.querySelectorAll('.reg-cb');
        cbs.forEach(cb => cb.checked = el.checked);
        updateRegionTriggerText();
    }

    function checkAllRegionState() {
        const cbs = document.querySelectorAll('.reg-cb');
        const allCb = document.getElementById('reg-all');
        const allChecked = Array.from(cbs).every(cb => cb.checked);
        allCb.checked = allChecked;
        updateRegionTriggerText();
    }

    function updateRegionTriggerText() {
        const cbs = document.querySelectorAll('.reg-cb');
        const checked = Array.from(cbs).filter(cb => cb.checked);
        const textSpan = document.getElementById('regionTriggerText');
        
        if (checked.length === cbs.length || cbs.length === 0) {
            textSpan.textContent = "é€‰æ‹©åœ°åŒº (å…¨éƒ¨)";
        } else if (checked.length === 0) {
            textSpan.textContent = "é€‰æ‹©åœ°åŒº (æœªé€‰)";
        } else if (checked.length <= 2) {
            textSpan.textContent = checked.map(cb => cb.value).join(', ');
        } else {
            textSpan.textContent = `å·²é€‰ ${checked.length} ä¸ªåœ°åŒº`;
        }
    }

    function toggleAllDomains(el) {
        const cbs = document.querySelectorAll('.cat-cb');
        cbs.forEach(cb => cb.checked = el.checked);
        updateTriggerText();
    }

    function checkAllState() {
        const cbs = document.querySelectorAll('.cat-cb');
        const allCb = document.getElementById('cat-all');
        const allChecked = Array.from(cbs).every(cb => cb.checked);
        allCb.checked = allChecked;
        updateTriggerText();
    }

    function updateTriggerText() {
        const cbs = document.querySelectorAll('.cat-cb');
        const checked = Array.from(cbs).filter(cb => cb.checked);
        const textSpan = document.getElementById('domainTriggerText');
        
        if (checked.length === cbs.length) {
            textSpan.textContent = "é€‰æ‹©é¢†åŸŸ (å…¨éƒ¨)";
        } else if (checked.length === 0) {
            textSpan.textContent = "é€‰æ‹©é¢†åŸŸ (æœªé€‰)";
        } else if (checked.length <= 2) {
            textSpan.textContent = checked.map(cb => cb.value).join(', ');
        } else {
            textSpan.textContent = `å·²é€‰ ${checked.length} ä¸ªé¢†åŸŸ`;
        }
    }

    function toggleAllSources(el) {
        const cbs = document.querySelectorAll('.src-cb');
        cbs.forEach(cb => cb.checked = el.checked);
        updateSourceTriggerText();
    }

    function checkAllSourceState() {
        const cbs = document.querySelectorAll('.src-cb');
        const allCb = document.getElementById('src-all');
        const allChecked = Array.from(cbs).every(cb => cb.checked);
        allCb.checked = allChecked;
        updateSourceTriggerText();
    }

    function updateSourceTriggerText() {
        const cbs = document.querySelectorAll('.src-cb');
        const checked = Array.from(cbs).filter(cb => cb.checked);
        const textSpan = document.getElementById('sourceTriggerText');
        
        if (checked.length === cbs.length || cbs.length === 0) {
            textSpan.textContent = "é€‰æ‹©æ¥æº (å…¨éƒ¨)";
        } else if (checked.length === 0) {
            textSpan.textContent = "é€‰æ‹©æ¥æº (æœªé€‰)";
        } else if (checked.length <= 2) {
            textSpan.textContent = checked.map(cb => cb.value).join(', ');
        } else {
            textSpan.textContent = `å·²é€‰ ${checked.length} ä¸ªæ¥æº`;
        }
    }

    // --- Loading Logic ---
    window.addEventListener('DOMContentLoaded', () => {
        loadDefaultReport();
    });

    async function loadDefaultReport() {
        document.getElementById('loading').style.display = 'flex';
        try {
            const res = await fetch(`/api/report/analysis`);
            const data = await res.json();
            switchView('dashboard');
            renderReport(data, 'dashboard');
        } catch (e) {
            console.error("åŠ è½½é»˜è®¤æŠ¥è¡¨å¤±è´¥", e);
            generateReport();
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // --- Recent Reports ---
    async function loadRecentReports() {
        try {
            const res = await fetch('/api/report/recent');
            const reports = await res.json();
            const container = document.getElementById('recentReportsList');
            container.innerHTML = '<span class="recent-label">æœ€è¿‘ç”Ÿæˆ:</span>';
            
            reports.forEach(r => {
                const tag = document.createElement('span');
                tag.className = 'recent-tag';
                tag.textContent = r.keyword;
                tag.onclick = () => {
                    document.getElementById('keyword').value = r.keyword;
                    loadHistoryReport(r.id, r.keyword);
                };
                container.appendChild(tag);
            });
        } catch (e) {
            console.error("Load recent reports failed", e);
        }
    }

    // --- History Sidebar ---
    function toggleHistorySidebar() {
        const sb = document.getElementById('historySidebar');
        sb.classList.toggle('show');
        if (sb.classList.contains('show')) {
            const keyword = document.getElementById('keyword').value.trim();
            loadHistoryList(keyword);
        }
    }

    async function loadHistoryList(keyword) {
        const list = document.getElementById('historyList');
        const title = document.getElementById('historyTitle');
        const quickAccess = document.getElementById('historyQuickAccess');
        
        title.textContent = keyword ? `${keyword} - å†å²æŠ¥å‘Š` : `å¤§ç›˜ - å†å²æŠ¥å‘Š`;
        list.innerHTML = '<div style="color:#999;padding:10px;">åŠ è½½ä¸­...</div>';
        
        try {
            const url = keyword ? `/api/report/history?keyword=${encodeURIComponent(keyword)}` : `/api/report/history`;
            const res = await fetch(url);
            const history = await res.json();
            
            // Populate Quick Access
            if (quickAccess) {
                quickAccess.innerHTML = '';
                const displayCount = 5;
                const hasMore = history.length > displayCount;
                const displayItems = history.slice(0, displayCount);
                
                displayItems.forEach(h => {
                    const tag = document.createElement('div');
                    // Add specific class based on report type
                    const typeClass = h.type ? `qa-${h.type}` : 'qa-daily';
                    tag.className = `history-qa-item ${typeClass}`;
                    
                    let label = '';
                    if (h.keyword) {
                        // Keyword report
                        label = h.keyword + ' ' + h.date.substring(5, 10);
                        // Keyword reports might default to daily style or have their own
                        if (!h.type) tag.classList.add('qa-keyword'); 
                    } else {
                        // Dashboard report
                        const typeMap = { 'daily': 'æ—¥æŠ¥', 'weekly': 'å‘¨æŠ¥', 'monthly': 'æœˆæŠ¥' };
                        const typeLabel = typeMap[h.type] || h.type || 'å¤§ç›˜';
                        label = typeLabel + ' ' + h.date.substring(5, 10);
                    }
                    tag.textContent = label;
                    tag.onclick = () => loadHistoryReport(h.id, keyword);
                    quickAccess.appendChild(tag);
                });

                if (hasMore) {
                    const moreBtn = document.createElement('div');
                    moreBtn.className = 'history-qa-more';
                    moreBtn.textContent = 'æ›´å¤š...';
                    moreBtn.onclick = toggleHistorySidebar;
                    quickAccess.appendChild(moreBtn);
                }
            }
            
            list.innerHTML = '';
            if (history.length === 0) {
                list.innerHTML = '<div style="color:#999;padding:10px;">æš‚æ— å†å²</div>';
                if(quickAccess) quickAccess.innerHTML = '<span style="color:#999;font-size:0.85rem">æš‚æ— å†å²æŠ¥å‘Š</span>';
                return;
            }
            
            const grouped = {};
            history.forEach(h => {
                const datePart = h.date.split(' ')[0];
                if (!grouped[datePart]) grouped[datePart] = [];
                grouped[datePart].push(h);
            });
            
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
            
            sortedDates.forEach(dateStr => {
                const groupTitle = document.createElement('div');
                groupTitle.className = 'history-group-title';
                groupTitle.textContent = dateStr;
                list.appendChild(groupTitle);
                
                const items = grouped[dateStr];
                
                items.forEach(h => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    
                    let content = '';
                    if (!keyword) {
                        const type = h.type || 'weekly';
                        const typeMap = { 'daily': 'æ—¥æŠ¥', 'weekly': 'å‘¨æŠ¥', 'monthly': 'æœˆæŠ¥' };
                        const typeLabel = typeMap[type] || type;
                        const typeClass = `tag-${type}`;
                        content = `<span class="report-tag ${typeClass}">${typeLabel}</span> <span style="font-size:0.8rem;color:#64748b">${h.date.split(' ')[1]}</span>`;
                    } else {
                        content = `<span>${h.date.substring(5)}</span>`;
                    }
                    
                    item.innerHTML = content;
                    item.onclick = () => loadHistoryReport(h.id, keyword);
                    list.appendChild(item);
                });
            });
            
        } catch (e) {
            console.error(e);
            list.innerHTML = '<div style="color:red;padding:10px;">åŠ è½½å¤±è´¥</div>';
        }
    }

    async function loadHistoryReport(id, keyword) {
        document.getElementById('loading').style.display = 'flex';
        try {
            const res = await fetch(`/api/report/load/${id}`);
            const data = await res.json();
            
            document.getElementById('keyword').value = keyword || '';
            
            if (keyword) {
                switchView('keyword');
                renderReport(data, 'keyword');
            } else {
                switchView('dashboard');
                renderReport(data, 'dashboard');
            }
            
            loadHistoryList(keyword);
            
        } catch (e) {
            alert("åŠ è½½æŠ¥å‘Šå¤±è´¥: " + e);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // --- Core Generation ---
    // Global Polling State
    let pollingInterval = null;
    let pollingKeyword = null;
    let pollingStartTime = null;

    function showBackgroundNotification() {
        document.getElementById('bgNotification').style.display = 'block';
        document.getElementById('pollingStatus').textContent = "â³ æ­£åœ¨å¤„ç†...";
    }
    
    function hideBackgroundNotification() {
        document.getElementById('bgNotification').style.display = 'none';
        stopPolling();
    }
    
    function stopPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
    }
    
    function startPolling(keyword) {
        stopPolling();
        pollingKeyword = keyword;
        pollingStartTime = new Date();
        
        pollingInterval = setInterval(async () => {
            try {
                // Check recent reports
                const res = await fetch(`/api/report/recent?limit=1&keyword=${encodeURIComponent(keyword || '')}`);
                const data = await res.json();
                if (data && data.length > 0) {
                    const latest = data[0];
                    const reportTime = new Date(latest.created_at);
                    
                    // If report is newer than start time (with 10s buffer for clock skew)
                    if (reportTime > new Date(pollingStartTime.getTime() - 10000)) {
                        stopPolling();
                        document.getElementById('pollingStatus').textContent = "âœ… ç”Ÿæˆå®Œæˆï¼æ­£åœ¨åŠ è½½...";
                        setTimeout(() => {
                             loadHistoryReport(latest.id, keyword);
                             hideBackgroundNotification();
                             loadRecentReports(); 
                        }, 1000);
                    }
                }
            } catch(e) { console.error("Polling error", e); }
        }, 5000);
    }

    function openSettingsModal() { document.getElementById('settingsModal').classList.add('show'); }
    function closeSettingsModal() { document.getElementById('settingsModal').classList.remove('show'); }
    function confirmGenerate() { closeSettingsModal(); generateReport(true); }
    document.getElementById('settingsModal').addEventListener('click', function(e) { if (e.target === this) closeSettingsModal(); });

    async function generateReport(isBackground = false) {
        const keyword = document.getElementById('keyword').value.trim();
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const limit = document.getElementById('limitSelect').value;
        
        const allCb = document.getElementById('cat-all');
        let category = 'all';
        if (!allCb.checked) {
            const selected = Array.from(document.querySelectorAll('.cat-cb:checked')).map(cb => cb.value);
            if (selected.length === 0) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¢†åŸŸ'); return; }
            category = selected.join(',');
        }

        const allSrcCb = document.getElementById('src-all');
        let source = '';
        if (allSrcCb && !allSrcCb.checked) {
            const selectedSrc = Array.from(document.querySelectorAll('.src-cb:checked')).map(cb => cb.value);
            if (selectedSrc.length > 0) {
                source = selectedSrc.join(',');
            }
        }
        
        const allRegCb = document.getElementById('reg-all');
        let region = 'all';
        if (allRegCb && !allRegCb.checked) {
            const selectedReg = Array.from(document.querySelectorAll('.reg-cb:checked')).map(cb => cb.value);
            if (selectedReg.length > 0) {
                region = selectedReg.join(',');
            }
        }

        // Save params
        window.currentReportParams = { keyword, start, end, limit, category, source, region };
        
        if (isBackground) {
             pollingStartTime = new Date();
             const params = new URLSearchParams({
                 q: keyword,
                 start_date: start || '',
                 end_date: end || '',
                 category: category === 'all' ? '' : category,
                 source: source,
                 region: region === 'all' ? '' : region,
                 limit: limit,
                 generate_ai: 'true'
             });
             
             try {
                 const res = await fetch(`/api/report/generate?${params.toString()}`, { method: 'POST' });
                 if (!res.ok) throw new Error("æäº¤å¤±è´¥");
                 
                 showBackgroundNotification();
                 startPolling(keyword);
             } catch(e) {
                 alert("ä»»åŠ¡æäº¤å¤±è´¥: " + e.message);
             }
             return;
        }

        document.getElementById('loading').style.display = 'flex';
        
        try {
            const params = new URLSearchParams({
                q: keyword,
                start_date: start,
                end_date: end,
                category: category,
                source: source,
                region: region,
                limit: limit,
                generate_ai: 'true'
            });
            const res = await fetch(`/api/report/analysis?${params.toString()}`);
            const data = await res.json();
            
            if (keyword) {
                switchView('keyword');
                renderReport(data, 'keyword');
                loadRecentReports();
                loadHistoryList(keyword);
            } else {
                switchView('dashboard');
                renderReport(data, 'dashboard');
            }
            
            ['filter-word_cloud', 'filter-source', 'filter-sentiment', 'filter-list'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = 'all';
            });
            
        } catch (e) {
            alert('ç”Ÿæˆå¤±è´¥: ' + e);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function switchView(mode) {
        const common = document.getElementById('commonCharts');
        const keyw = document.getElementById('keywordView');
        
        common.style.display = 'block';

        if (mode === 'keyword') {
            keyw.style.display = 'block';
        } else {
            keyw.style.display = 'none';
            document.getElementById('historySidebar').classList.remove('show');
        }
    }

    async function updateChart(type, category) {
        const keyword = document.getElementById('keyword').value.trim();
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        
        try {
             const params = new URLSearchParams({
                type: type,
                q: keyword,
                start_date: start,
                end_date: end,
                category: category
            });
            const res = await fetch(`/api/report/chart-data?${params.toString()}`);
            const data = await res.json();
            
            if (type === 'word_cloud') renderWordCloud(data);
            else if (type === 'source') renderSourceChart(data);
            else if (type === 'sentiment') {
                const sentimentDist = Array.isArray(data) ? data : (data.sentiment_dist || []);
                const negKeywords = Array.isArray(data) ? [] : (data.neg_keywords || []);
                renderSentimentChart(sentimentDist);
                document.getElementById('negKeywords').innerText = (negKeywords || []).join(', ');
            }
            else if (type === 'list') renderNewsList(data);

        } catch (e) {
            console.error("Update chart failed", e);
        }
    }

    function renderReport(data, mode) {
        window.currentReportParams = data.params;
        ['aiSection', 'metricsSection', 'tableSection'].forEach(id => {
            document.getElementById(id).style.display = (id === 'metricsSection') ? 'grid' : 'block';
        });

        const s = data.summary;
        const avgHeat = Number(s.avg_heat ?? 0);
        const sentimentIdx = Number(s.sentiment_idx ?? 0);
        document.getElementById('valTotal').innerText = s.total;
        document.getElementById('valAvgHeat').innerText = avgHeat.toFixed(2);
        document.getElementById('valMaxHeat').innerText = s.max_heat;
        document.getElementById('valSentiment').innerText = sentimentIdx.toFixed(2);
        document.getElementById('valSentiment').style.color = sentimentIdx < 50 ? '#ef4444' : '#10b981';
        document.getElementById('valRisk').innerText = s.risk_count;
        document.getElementById('valTimeRange').innerText = s.time_range;

        let aiText = data.ai_analysis || "æš‚æ— åˆ†æ";
        aiText = aiText.replace(/\n{3,}/g, '\n\n');
        document.getElementById('aiContent').innerHTML = marked.parse(aiText);

        renderTrendChart(data.charts.trend);
        renderWordCloud(data.charts.word_cloud);
        renderSourceChart(data.charts.source);
        renderSentimentChart(data.charts.sentiment_dist);
        document.getElementById('negKeywords').innerText = (data.charts.neg_keywords || []).join(', ');

        if (mode === 'keyword') {
            renderCorrelationChart(data.charts.correlation);
            renderFreqTrendChart(data.charts.freq_trend);
            renderSentimentTrendChart(data.charts.sentiment_trend);
        }

        renderNewsList(data.top_news);
        updateInfoCard(data, mode);
    }
    
    function updateInfoCard(data, mode) {
        const card = document.getElementById('reportInfoCard');
        const titleEl = document.getElementById('infoTitle');
        const timeEl = document.getElementById('infoTime');
        const descEl = document.getElementById('infoDesc');
        const backBtn = document.getElementById('btnBackToGlobal');
        
        card.style.display = 'flex';
        
        const keyword = document.getElementById('keyword').value.trim();
        
        let catText = "æ‰€æœ‰é¢†åŸŸ";
        let srcText = "æ‰€æœ‰æ¥æº";
        
        if (data.params) {
            if (data.params.category && data.params.category !== 'all') {
                const cats = data.params.category.split(',');
                catText = cats.length > 3 ? `é€‰ä¸­ ${cats.length} ä¸ªé¢†åŸŸ` : data.params.category;
            }
            if (data.params.source && data.params.source !== 'all') {
                const srcs = data.params.source.split(',');
                srcText = srcs.length > 3 ? `é€‰ä¸­ ${srcs.length} ä¸ªæ¥æº` : data.params.source;
            }
        } else {
            const catEl = document.getElementById('domainTriggerText');
            const srcEl = document.getElementById('sourceTriggerText');
            if (catEl) catText = catEl.textContent;
            if (srcEl) srcText = srcEl.textContent;
        }

        if (mode === 'keyword') {
            titleEl.innerHTML = `å…³é”®è¯åˆ†æ: <span style="color:#fbbf24">${keyword}</span> <button class="btn-reanalyze" onclick="reAnalyze()" style="margin-left:12px; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-soft); color: var(--text-primary);">ğŸ”„ é‡æ–°åˆ†æ</button>`;
            backBtn.style.display = 'flex';
        } else {
            const typeMap = { daily: 'æ—¥æŠ¥', weekly: 'å‘¨æŠ¥', monthly: 'æœˆæŠ¥' };

            const toYYMMDD = (d) => (typeof d === 'string' && d.length >= 10 ? d.slice(2, 10) : '');
            const toYYMM = (d) => (typeof d === 'string' && d.length >= 7 ? d.slice(2, 7) : '');

            const parseTimeRange = (tr) => {
                if (!tr || tr === '-') return null;
                const normalized = String(tr).replace(/è‡³/g, '~');
                const parts = normalized.split('~').map(s => s.trim()).filter(Boolean);
                if (parts.length >= 2) return { start: parts[0], end: parts[1] };
                if (parts.length === 1) return { start: parts[0], end: parts[0] };
                return null;
            };

            const formatTitle = (period, timeRange) => {
                const label = typeMap[period] || 'æŠ¥è¡¨';
                const range = parseTimeRange(timeRange);
                if (!range) return label;
                if (period === 'daily') return `${label}ï¼ˆ${toYYMMDD(range.end)}ï¼‰`;
                if (period === 'weekly') return `${label}ï¼ˆ${toYYMMDD(range.start)} è‡³ ${toYYMMDD(range.end)}ï¼‰`;
                if (period === 'monthly') return `${label}ï¼ˆ${toYYMM(range.end)}ï¼‰`;
                return label;
            };

            titleEl.textContent = formatTitle(data.period, data?.summary?.time_range);
            backBtn.style.display = 'none';
        }
        
        timeEl.textContent = `æ—¶é—´èŒƒå›´: ${data.summary.time_range}`;
        descEl.textContent = `åˆ†æç»´åº¦: ${catText} | ${srcText}`;
    }

    function reAnalyze() {
        if (window.currentReportParams) {
            restoreFilters(window.currentReportParams);
        }
        openSettingsModal();
    }

    function restoreFilters(p) {
        if(!p) return;
        if(p.keyword) document.getElementById('keyword').value = p.keyword;
        if(p.start_date) document.getElementById('startDate').value = p.start_date;
        if(p.end_date) document.getElementById('endDate').value = p.end_date;
        if(p.limit) document.getElementById('limitSelect').value = p.limit;
        
        // Helper to set checkboxes
        const setChecks = (cls, allId, valStr) => {
            const allCb = document.getElementById(allId);
            const cbs = document.querySelectorAll('.' + cls);
            if (!valStr || valStr === 'all') {
                allCb.checked = true;
                cbs.forEach(cb => cb.checked = true);
            } else {
                allCb.checked = false;
                const vals = valStr.split(',');
                cbs.forEach(cb => cb.checked = vals.includes(cb.value));
            }
        };
        
        setChecks('cat-cb', 'cat-all', p.category);
        setChecks('src-cb', 'src-all', p.source);
        setChecks('reg-cb', 'reg-all', p.region);
        
        // Trigger UI updates
        updateTriggerText();
        updateSourceTriggerText();
        updateRegionTriggerText();
    }

    // --- Helper for Mobile Detection ---
    function isMobileScreen() {
        return window.innerWidth < 768;
    }

    function renderTrendChart(trendData) {
        if (chartTrend) chartTrend.dispose();
        chartTrend = echarts.init(document.getElementById('chartTrend'));
        
        const series = [];
        const legendData = [];
        const isMobile = isMobileScreen();
        
        if (trendData.category_series && trendData.category_series.length > 0) {
            trendData.category_series.forEach(s => {
                series.push(s);
                legendData.push(s.name);
            });
        } else {
             series.push({ name: 'æ–‡ç« æ•°', type: 'bar', data: trendData.counts, itemStyle: { color: '#3b82f6', borderRadius: [4,4,0,0] } });
             legendData.push('æ–‡ç« æ•°');
        }

        series.push({ 
            name: 'å¹³å‡çƒ­åº¦', type: 'line', yAxisIndex: 1, 
            data: trendData.avg_heats, itemStyle: { color: '#ef4444' }, 
            smooth: true, lineStyle: { width: 3 }, showSymbol: false
        });
        legendData.push('å¹³å‡çƒ­åº¦');

        chartTrend.setOption({
            tooltip: { 
                trigger: 'axis', 
                backgroundColor: 'rgba(255,255,255,0.95)', 
                textStyle: { color: '#333' },
                formatter: function (params) {
                    let res = params[0].name + '<br/>';
                    params.forEach(function (item) {
                        let val = item.value;
                        if (item.seriesName === 'å¹³å‡çƒ­åº¦' && typeof val === 'number') {
                            val = val.toFixed(2);
                        }
                        res += item.marker + " " + item.seriesName + ": " + val + '<br/>';
                    });
                    return res;
                }
            },
            legend: { 
                data: legendData, 
                bottom: 0,
                type: isMobile ? 'scroll' : 'plain',
                padding: isMobile ? [5, 10] : 5
            },
            grid: { 
                bottom: isMobile ? '15%' : '10%', 
                left: isMobile ? '2%' : '3%', 
                right: isMobile ? '2%' : '3%', 
                containLabel: true 
            },
            xAxis: { 
                type: 'category', 
                data: trendData.dates, 
                axisLine: { lineStyle: { color: '#e2e8f0' } }, 
                axisLabel: { 
                    color: '#64748b',
                    rotate: isMobile ? 45 : 0,
                    interval: isMobile ? 'auto' : 0
                } 
            },
            yAxis: [ 
                { type: 'value', name: isMobile ? '' : 'æ–‡ç« æ•°', splitLine: { lineStyle: { type: 'dashed' } } }, 
                { type: 'value', name: isMobile ? '' : 'çƒ­åº¦', splitLine: { show: false } } 
            ],
            series: series
        });
    }

    function renderWordCloud(words) {
        const container = document.getElementById('wordCloud');
        container.innerHTML = '';
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
        
        if (!words || words.length === 0) {
            container.innerHTML = '<div style="color:#999">æš‚æ— æ•°æ®</div>';
            return;
        }

        let maxVal = 0;
        let minVal = Infinity;
        words.forEach(w => {
            if (w.value > maxVal) maxVal = w.value;
            if (w.value < minVal) minVal = w.value;
        });

        // Dynamic sizing based on screen width
        const isMobile = isMobileScreen();
        const minSize = isMobile ? 0.75 : 0.85;
        const maxSize = isMobile ? 1.8 : 2.5;
        // Increased limit since we have a scrollable container now
        const maxWords = isMobile ? 100 : 200; 
        
        // Sort by value and take top N
        const displayWords = words.sort((a,b) => b.value - a.value).slice(0, maxWords);

        displayWords.forEach(w => {
            const span = document.createElement('span');
            span.className = 'cloud-tag';
            span.textContent = w.name;
            
            let size = minSize;
            if (maxVal > minVal) {
                size = minSize + ((w.value - minVal) / (maxVal - minVal)) * (maxSize - minSize);
            }
            span.style.fontSize = size + 'rem';
            span.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            container.appendChild(span);
        });
    }

    function renderSourceChart(sourceData) {
        if (chartSource) chartSource.dispose();
        chartSource = echarts.init(document.getElementById('chartSource'));
        const isMobile = isMobileScreen();
        
        chartSource.setOption({
            tooltip: { trigger: 'item' },
            legend: { 
                type: 'scroll', 
                orient: isMobile ? 'horizontal' : 'vertical', 
                left: isMobile ? 'center' : 'left',
                bottom: isMobile ? 0 : 'auto',
                top: isMobile ? 'auto' : 'middle'
            },
            series: [{
                name: 'æ¥æº', type: 'pie', 
                radius: isMobile ? ['35%', '60%'] : ['40%', '70%'],
                center: isMobile ? ['50%', '45%'] : ['60%', '50%'],
                data: sourceData,
                itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                label: { show: !isMobile }
            }]
        });
    }

    function renderSentimentChart(sentimentData) {
        if (chartSentiment) chartSentiment.dispose();
        chartSentiment = echarts.init(document.getElementById('chartSentiment'));
        const isMobile = isMobileScreen();

        chartSentiment.setOption({
            tooltip: { trigger: 'item' },
            legend: { bottom: '0%' },
            series: [{
                name: 'æƒ…æ„Ÿ', type: 'pie', 
                radius: isMobile ? ['35%', '60%'] : ['40%', '70%'],
                center: ['50%', '45%'],
                avoidLabelOverlap: false,
                label: { show: false, position: 'center' },
                emphasis: { label: { show: true, fontSize: isMobile ? '14' : '18', fontWeight: 'bold' } },
                data: sentimentData
            }]
        });
    }

    function renderCorrelationChart(data) {
        if (chartCorrelation) chartCorrelation.dispose();
        chartCorrelation = echarts.init(document.getElementById('chartCorrelation'));
        const isMobile = isMobileScreen();
        
        if (!data || !data.nodes || data.nodes.length === 0) {
             chartCorrelation.clear();
             return;
        }

        chartCorrelation.setOption({
            tooltip: {},
            series: [{
                type: 'graph',
                layout: 'force',
                data: data.nodes,
                links: data.links,
                roam: true,
                label: { show: !isMobile, position: 'right' },
                force: { repulsion: isMobile ? 100 : 200, edgeLength: isMobile ? 50 : 80 },
                lineStyle: { color: 'source', curveness: 0.3 }
            }]
        });
    }

    function renderFreqTrendChart(data) {
        if (chartFreqTrend) chartFreqTrend.dispose();
        chartFreqTrend = echarts.init(document.getElementById('chartFreqTrend'));
        const isMobile = isMobileScreen();
        
        if (!data || !data.series) { chartFreqTrend.clear(); return; }

        chartFreqTrend.setOption({
            tooltip: { trigger: 'axis' },
            legend: { bottom: 0, type: 'scroll' },
            grid: { bottom: isMobile ? '15%' : '10%' },
            xAxis: { type: 'category', data: data.dates },
            yAxis: { type: 'value' },
            series: data.series
        });
    }

    function renderSentimentTrendChart(data) {
        if (chartSentimentTrend) chartSentimentTrend.dispose();
        chartSentimentTrend = echarts.init(document.getElementById('chartSentimentTrend'));
        const isMobile = isMobileScreen();
        
        if (!data || !data.series) { chartSentimentTrend.clear(); return; }

        chartSentimentTrend.setOption({
            tooltip: { trigger: 'axis' },
            legend: { bottom: 0, type: 'scroll' },
            grid: { bottom: isMobile ? '15%' : '10%' },
            xAxis: { type: 'category', data: data.dates },
            yAxis: [
                { type: 'value', name: 'æ–‡ç« æ•°' },
                { type: 'value', name: 'æƒ…æ„Ÿåˆ†', min: 0, max: 100 }
            ],
            series: data.series
        });
    }

    // Global state for summary generation
    const state = { isGenerating: false };

    function renderSummaryHtml(summary, id) {
        if (!summary) {
            return `
                <div class="summary-placeholder">
                    <span>æš‚æ— æ‘˜è¦</span>
                    <button class="btn-link" onclick="genSummary(${id})">âœ¨ ç”Ÿæˆæ‘˜è¦</button>
                </div>
            `;
        }
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = summary;
        const textLength = tempDiv.innerText.length;
        const threshold = 300;
        
        if (textLength <= threshold) {
            return summary + ` <button class="btn-regen" onclick="genSummary(${id})">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>`;
        } else {
            return `
                <div id="summary-content-${id}" class="summary-content collapsed">
                    ${summary}
                </div>
                <button id="btn-expand-${id}" class="btn-link" onclick="toggleSummary(${id}, true)">æŸ¥çœ‹å…¨éƒ¨</button>
                <button id="btn-collapse-${id}" class="btn-link" style="display:none;" onclick="toggleSummary(${id}, false)">æ”¶èµ·</button>
                <button class="btn-regen" onclick="genSummary(${id})">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
            `;
        }
    }

    window.toggleSummary = (id, showFull) => {
        const content = document.getElementById(`summary-content-${id}`);
        const btnExpand = document.getElementById(`btn-expand-${id}`);
        const btnCollapse = document.getElementById(`btn-collapse-${id}`);
        
        if (content && btnExpand && btnCollapse) {
            if (showFull) {
                content.classList.remove('collapsed');
                btnExpand.style.display = 'none';
                btnCollapse.style.display = 'inline';
            } else {
                content.classList.add('collapsed');
                btnExpand.style.display = 'inline';
                btnCollapse.style.display = 'none';
                
                // æ”¶èµ·æ—¶æ»šåŠ¨å›æ–°é—»å¡ç‰‡é¡¶éƒ¨
                const card = content.closest('.news-card');
                if (card) {
                    const headerOffset = 80; 
                    const elementPosition = card.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.scrollY - headerOffset;
                    
                    window.scrollTo({
                            top: offsetPosition,
                            behavior: "smooth"
                    });
                }
            }
        }
    };

    window.genSummary = async (id) => {
        if (state.isGenerating) return;
        
        const box = document.getElementById(`summary-${id}`);
        if (!box) return;
        
        state.isGenerating = true;
        updateRegenButtonsState();

        const originalContent = box.innerHTML;
        const isRegen = box.querySelector('.btn-regen') !== null;
        
        if (isRegen) {
            const btn = box.querySelector('.btn-regen');
            if (btn) btn.innerText = "â³ ç”Ÿæˆä¸­...";
        } else {
            box.innerHTML = '<span style="color:var(--primary)">æ­£åœ¨ç”Ÿæˆæ‘˜è¦...</span>';
        }
        
        try {
            const res = await fetch(`/api/generate_summary/${id}`, { method: 'POST' });
            const data = await res.json();
            if (data.summary) {
                box.innerHTML = renderSummaryHtml(data.summary, id);
            } else {
                throw new Error("Empty summary");
            }
        } catch (err) {
            alert('ç”Ÿæˆå¤±è´¥');
            box.innerHTML = originalContent;
        } finally {
            state.isGenerating = false;
            updateRegenButtonsState();
        }
    };

    function updateRegenButtonsState() {
        const regenBtns = document.querySelectorAll('.btn-regen');
        const createBtns = document.querySelectorAll('.summary-placeholder .btn-link');
        
        const setDisabled = (btn) => {
            btn.disabled = state.isGenerating;
            if (state.isGenerating) btn.style.opacity = '0.5';
            else btn.style.opacity = '1';
            btn.style.cursor = state.isGenerating ? 'not-allowed' : 'pointer';
        };

        regenBtns.forEach(setDisabled);
        createBtns.forEach(setDisabled);
    }

    window.toggleRelated = (id) => {
        const el = document.getElementById(`related-${id}`);
        if (el) {
            if (el.classList.contains('show')) el.classList.remove('show');
            else {
                document.querySelectorAll('.related-content.show').forEach(d => d.classList.remove('show'));
                el.classList.add('show');
            }
        }
    };

    function renderNewsList(newsList) {
        const container = document.getElementById('hotNewsList');
        // Clean up pagination container if it exists from previous state
        const paginationContainer = document.getElementById('newsPagination');
        if (paginationContainer) paginationContainer.innerHTML = '';
        
        if (!container) return;
        
        container.innerHTML = '';
        
        if (!newsList || newsList.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#999;padding:20px">æš‚æ— çƒ­é—¨èˆ†æƒ…æ•°æ®</div>';
            return;
        }

        newsList.forEach((news, index) => {
            const card = document.createElement('div');
            card.className = 'news-card';
            
            // Determine sentiment class
            const sentiment = (news.sentiment_label || news.sentiment || 'ä¸­ç«‹').trim();
            let sentimentClass = 'sent-neu';
            
            if (sentiment === 'æ­£é¢') sentimentClass = 'sent-pos';
            else if (sentiment === 'è´Ÿé¢') sentimentClass = 'sent-neg';

            // Rank
            const rank = news.rank || (index + 1);
            
            const heat = typeof news.heat === 'number' ? news.heat.toFixed(1) : news.heat;
            
            // Format time if available
            let timeStr = '';
            if (news.time || news.created_at) {
                const t = new Date(news.time || news.created_at);
                if (!isNaN(t.getTime())) {
                    timeStr = t.toLocaleString('zh-CN', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
                }
            }

            card.innerHTML = `
                <div class="card-body">
                    <div class="rank">${rank}</div>
                    <div class="content">
                        <div class="news-head">
                            <a href="${news.url}" target="_blank" class="news-title">${news.title}</a>
                        </div>

                        <div class="meta-row">
                            <div class="meta-left">
                                <span class="tag tag-category">${news.category || 'å…¶ä»–'}</span>
                                <span class="tag tag-heat">ğŸ”¥ ${heat || 0}</span>
                                <span class="tag sentiment-pill ${sentimentClass}">${sentiment}</span>
                            </div>
                            <div class="meta-right">
                                <span class="time-str">${timeStr}</span>
                                ${news.sources && news.sources.length > 0 ? `
                                    <div class="related-dropdown">
                                        <button class="btn-link" onclick="toggleRelated(${news.id})">ğŸ”— å…³è”æŠ¥é“ (${news.sources.length}) â–¼</button>
                                        <div class="related-content" id="related-${news.id}">
                                            ${news.sources.map(src => `
                                                <div class="related-item">
                                                    <span style="flex:1; margin-right:8px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${src.name || 'æœªçŸ¥æ¥æº'}</span>
                                                    <a href="${src.url}" target="_blank" class="related-link">æŸ¥çœ‹åŸæ–‡ â†—</a>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : `
                                    <button class="btn-link" onclick="window.open('${news.url}', '_blank')">æŸ¥çœ‹è¯¦æƒ…</button>
                                `}
                            </div>
                        </div>
                        
                        <div class="summary-box" id="summary-${news.id}">
                            ${renderSummaryHtml(news.summary, news.id)}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    window.onresize = () => {
        if(chartTrend) chartTrend.resize();
        if(chartSource) chartSource.resize();
        if(chartSentiment) chartSentiment.resize();
        if(chartCorrelation) chartCorrelation.resize();
        if(chartFreqTrend) chartFreqTrend.resize();
        if(chartSentimentTrend) chartSentimentTrend.resize();
    };
</script>
{% endblock %}
