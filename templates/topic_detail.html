{% extends "base.html" %}
{% block title %}专题详情 - {{ settings.APP_NAME }}{% endblock %}
{% block body_class %}page-topic-detail{% endblock %}
{% block head %}
{% endblock %}

{% block content %}
<div class="app-container page-wrap">
    <div class="back-row"><a class="back-link" href="/topics">← 返回专题列表</a></div>

    <div id="loading" class="loading">加载中...</div>
    <div id="error" class="err hidden"></div>

    <div id="header" class="topic-header hidden">
        <div id="topicName" class="topic-name"></div>
        <div class="meta">
            <span id="startTag"></span>
            <span id="updatedTag"></span>
        </div>
        <div id="summaryBox" class="card topic-summary hidden">
            <div class="card-title">事件概览</div>
            <div id="summaryText" class="text"></div>
        </div>
    </div>

    <div id="grid" class="grid hidden">
        <div class="card">
            <div class="card-head">
                <div class="card-title">时间轴</div>
                <button id="sortBtn" class="btn-mini" type="button" onclick="toggleSort()">切换倒序</button>
            </div>
            <div id="timeline" class="timeline"></div>
        </div>
        <div class="card">
            <div class="card-head">
                <div class="card-title">专题综述</div>
                <button id="regenBtn" class="btn-mini" type="button" onclick="regenerateOverview()">重新生成</button>
            </div>
            <div id="record" class="text"></div>
        </div>
    </div>

    <div id="newsCard" class="card hidden">
        <div class="card-title">来源新闻</div>
        <div id="newsList" class="news-list"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/marked.min.js"></script>
<script>
    const TOPIC_ID = {{ topic_id }};
    let currentSort = "asc"; // 默认正序

    function fmtTime(iso) {
        if (!iso) return "-";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        return d.toLocaleString();
    }

    function el(tag, attrs = {}, children = []) {
        const node = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
            if (k === "class") node.className = v;
            else if (k === "text") node.textContent = v;
            else if (k === "html") node.innerHTML = v;
            else node.setAttribute(k, v);
        }
        for (const c of children) node.appendChild(c);
        return node;
    }
    
    function toggleSort() {
        currentSort = (currentSort === "asc") ? "desc" : "asc";
        loadDetail();
    }

    window.toggleSourceGroup = function(header) {
        const list = header.nextElementSibling;
        const icon = header.querySelector(".toggle-icon");
        if (list.classList.contains("hidden")) {
            list.classList.remove("hidden");
            icon.style.transform = "rotate(180deg)";
        } else {
            list.classList.add("hidden");
            icon.style.transform = "rotate(0deg)";
        }
    };
    
    async function regenerateOverview() {
        if(!confirm("确定要重新生成专题综述吗？这可能需要几十秒钟。")) return;
        const btn = document.getElementById("regenBtn");
        btn.disabled = true;
        btn.textContent = "生成中...";
        try {
            const resp = await fetch(`/api/topics/${TOPIC_ID}/regenerate_overview`, { method: "POST" });
            if(resp.ok) {
                // 重新加载页面详情
                await loadDetail(); 
                alert("生成成功");
            } else {
                alert("生成失败");
            }
        } catch(e) {
            alert("请求出错: " + e.message);
        } finally {
            btn.disabled = false;
            btn.textContent = "重新生成";
        }
    }

    async function loadDetail() {
        const loading = document.getElementById("loading");
        const error = document.getElementById("error");
        const header = document.getElementById("header");
        const grid = document.getElementById("grid");
        const newsCard = document.getElementById("newsCard");
        const sortBtn = document.getElementById("sortBtn");

        // 如果是首次加载（loading可见），才显示loading；后续刷新不显示全屏loading
        if (loading.style.display !== "none") {
             // keep loading visible
        }

        try {
            error.classList.add("hidden"); // 清除之前的错误
            // 更新按钮文案
            sortBtn.textContent = (currentSort === "asc") ? "切换倒序" : "切换正序";

            const resp = await fetch(`/api/topics/${TOPIC_ID}?sort=${currentSort}`, { method: "GET", cache: "no-store" });
            if (!resp.ok) throw new Error("请求失败");
            const data = await resp.json();
            const topic = data.topic || {};

            document.getElementById("topicName").textContent = topic.name || "未命名专题";
            document.getElementById("startTag").textContent = `发布时间 ${fmtTime(topic.start_time)}`;
            document.getElementById("updatedTag").textContent = `更新时间 ${fmtTime(topic.updated_time)}`;

            const summary = (topic.summary || "").trim();
            if (summary) {
                document.getElementById("summaryText").textContent = summary;
                document.getElementById("summaryBox").classList.remove("hidden");
            } else {
                document.getElementById("summaryBox").classList.add("hidden");
            }

            const timelineEl = document.getElementById("timeline");
            timelineEl.innerHTML = "";
            const timeline = data.timeline || [];
            if (!timeline.length) {
                timelineEl.appendChild(el("div", { class: "text", text: "暂无时间轴条目。" }));
            } else {
                for (const it of timeline) {
                    const item = el("div", { class: "tl-item" });
                    item.appendChild(el("div", { class: "tl-time", text: fmtTime(it.time) }));
                    item.appendChild(el("div", { class: "tl-content", text: it.content || "" }));
                    
                    // Display multiple sources if available
                    if (it.sources && it.sources.length > 0) {
                        const sourcesContainer = el("div", { class: "tl-source" });
                        sourcesContainer.appendChild(document.createTextNode("来源: "));
                        
                        it.sources.forEach((source, index) => {
                            if (index > 0) {
                                sourcesContainer.appendChild(document.createTextNode(", "));
                            }
                            const a = el("a", { 
                                href: source.url, 
                                target: "_blank", 
                                rel: "noopener noreferrer", 
                                text: source.name || source.title || "来源"
                            });
                            sourcesContainer.appendChild(a);
                        });
                        item.appendChild(sourcesContainer);
                    } else if (it.source_url) {
                        // Fallback for backward compatibility
                        const a = el("a", { href: it.source_url, target: "_blank", rel: "noopener noreferrer", text: (it.source_name || "来源") });
                        const src = el("div", { class: "tl-source" }, [a]);
                        item.appendChild(src);
                    }
                    
                    timelineEl.appendChild(item);
                }
            }

            const recordContent = (topic.record || "").trim();
            const recordEl = document.getElementById("record");
            if (recordContent) {
                recordEl.innerHTML = marked.parse(recordContent);
                recordEl.classList.remove("text");
                recordEl.classList.add("markdown-body");
            } else {
                recordEl.textContent = "暂无专题综述（等待更多时间轴条目或下一次更新）。";
                recordEl.classList.add("text");
                recordEl.classList.remove("markdown-body");
            }

            const newsListEl = document.getElementById("newsList");
            newsListEl.innerHTML = "";
            const news = data.news || [];
            
            if (news.length) {
                // Group by source
                const groups = {};
                news.forEach(n => {
                    const s = n.source || "未知来源";
                    if (!groups[s]) groups[s] = [];
                    groups[s].push(n);
                });
                
                // Sort by count desc
                const sortedSources = Object.keys(groups).sort((a, b) => groups[b].length - groups[a].length);
                
                for (const src of sortedSources) {
                    const items = groups[src];
                    const groupCard = el("div", { class: "news-card source-group" });
                    
                    // Header (Click to toggle)
                    const header = el("div", { class: "source-header", onclick: "toggleSourceGroup(this)" });
                    header.innerHTML = `
                        <div class="source-title-row">
                            <span class="source-name">${src}</span>
                            <span class="source-count-badge">${items.length}</span>
                        </div>
                        <span class="toggle-icon">▼</span>
                    `;
                    groupCard.appendChild(header);
                    
                    // List (Hidden by default)
                    const list = el("div", { class: "source-list hidden" });
                    items.forEach(n => {
                        const itemRow = el("div", { class: "source-item-row" });
                        
                        // Title Link
                        const a = el("a", { 
                            class: "source-link", 
                            href: n.url || "#", 
                            target: "_blank", 
                            text: n.title || "(无标题)" 
                        });
                        
                        // Time
                        const timeSpan = el("span", { class: "source-time", text: fmtTime(n.time) });
                        
                        itemRow.appendChild(a);
                        itemRow.appendChild(timeSpan);
                        list.appendChild(itemRow);
                    });
                    groupCard.appendChild(list);
                    
                    newsListEl.appendChild(groupCard);
                }
                newsCard.classList.remove("hidden");
            } else {
                newsCard.classList.add("hidden");
            }

            header.classList.remove("hidden");
            grid.classList.remove("hidden");
            loading.style.display = "none"; // 确保加载完成后隐藏loading
        } catch (e) {
            error.classList.remove("hidden");
            error.textContent = "加载失败，请稍后重试。";
            loading.style.display = "none";
        }
    }

    loadDetail();
</script>
{% endblock %}
